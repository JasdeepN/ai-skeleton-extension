name: Pre-release (main)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

jobs:
  prerelease:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Bump patch version
        id: bump
        run: |
          CURRENT=$(jq -r '.version' package.json)
          IFS='.' read -r major minor patch <<< "$CURRENT"
          NEW_VERSION="${major}.${minor}.$((patch + 1))"
          jq ".version = \"$NEW_VERSION\"" package.json > package.tmp && mv package.tmp package.json
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "new=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "Bumped version: $CURRENT -> $NEW_VERSION"

      - name: Install dependencies
        run: npm ci

      - name: Compile TypeScript
        run: npm run compile

      - name: Run unit tests with coverage
        run: npm run test:coverage

      - name: Upload coverage reports (pre-release)
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/coverage-final.json
          flags: prerelease
          verbose: true
          fail_ci_if_error: true

      - name: Run E2E tests (Linux)
        run: xvfb-run -a npm run test:e2e

      - name: Build VSIX package
        run: npm run package:vsix

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: ai-skeleton-extension-${{ env.VERSION }}
          path: vsix/ai-skeleton-extension-${{ env.VERSION }}.vsix
          retention-days: 30

      - name: Commit version bump to main
        env:
          VERSION: ${{ env.VERSION }}
        run: |
          git config user.name "release-bot"
          git config user.email "release-bot@local"
          git add package.json src/promptStore.ts src/agentStore.ts vsix/last-version.json 2>/dev/null || true
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: prerelease v$VERSION"
            git push origin HEAD:main
          fi
          echo "NEW_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV

      - name: Create GitHub pre-release
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ env.VERSION }}
          name: v${{ env.VERSION }} (pre-release)
          prerelease: true
          draft: false
          allowUpdates: true
          commit: ${{ env.NEW_SHA }}
          artifacts: vsix/ai-skeleton-extension-${{ env.VERSION }}.vsix
          artifactErrorsFailBuild: true
          generateReleaseNotes: true
