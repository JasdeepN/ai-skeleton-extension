name: Release to Marketplace

on:
  pull_request:
    types: [closed]
    branches: [release]
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

env:
  NODE_VERSION: '20.x'

jobs:
  release:
    name: Release & Publish
    # Only run if PR was merged (not just closed) or manually triggered
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Get current version
        id: current-version
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Current version: $VERSION"

      - name: Strip pre-release suffix if present
        id: clean-version
        run: |
          VERSION=${{ steps.current-version.outputs.version }}
          # Remove -pre.X suffix if present
          CLEAN_VERSION=$(echo "$VERSION" | sed 's/-pre\.[0-9]*$//')
          
          if [ "$VERSION" != "$CLEAN_VERSION" ]; then
            echo "cleaned=true" >> $GITHUB_OUTPUT
            echo "clean_version=$CLEAN_VERSION" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Cleaning version: $VERSION â†’ $CLEAN_VERSION"
          else
            echo "cleaned=false" >> $GITHUB_OUTPUT
            echo "clean_version=$VERSION" >> $GITHUB_OUTPUT
            echo "âœ… Version already clean: $VERSION"
          fi

      - name: Update version to stable
        if: steps.clean-version.outputs.cleaned == 'true'
        run: |
          CLEAN_VERSION=${{ steps.clean-version.outputs.clean_version }}
          
          # Update package.json with clean version
          jq ".version = \"$CLEAN_VERSION\"" package.json > package.json.tmp
          mv package.json.tmp package.json
          
          git config user.name "Release Bot"
          git config user.email "release@bot.local"
          git add package.json
          git commit -m "chore: release version $CLEAN_VERSION [skip ci]"
          git push origin release
          
          echo "âœ… Updated to stable version $CLEAN_VERSION"

      - name: Get final version
        id: final-version
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Release version: $VERSION"

      - name: Check for existing release tag
        id: tag-check
        run: |
          VERSION=${{ steps.final-version.outputs.version }}
          git fetch --tags --prune --prune-tags
          
          if git rev-parse "refs/tags/v${VERSION}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Tag v${VERSION} already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ… Creating new tag v${VERSION}"
          fi

      - name: Download pre-release VSIX
        id: download-vsix
        run: |
          VERSION=${{ steps.final-version.outputs.version }}
          PRE_TAG="v${VERSION}-pre"
          
          # Try to download VSIX from pre-release
          if gh release view "$PRE_TAG" >/dev/null 2>&1; then
            echo "â„¹ï¸ Found pre-release $PRE_TAG, downloading VSIX..."
            mkdir -p vsix
            gh release download "$PRE_TAG" --pattern "*.vsix" --dir vsix
            echo "source=prerelease" >> $GITHUB_OUTPUT
            echo "âœ… Downloaded VSIX from pre-release"
          else
            echo "source=build" >> $GITHUB_OUTPUT
            echo "âš ï¸ No pre-release found, will build VSIX"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build VSIX if not downloaded
        if: steps.download-vsix.outputs.source == 'build'
        run: |
          npm ci
          npm run compile
          mkdir -p vsix
          npx @vscode/vsce package --out vsix/ai-skeleton-extension-${{ steps.final-version.outputs.version }}.vsix
          echo "âœ… Built VSIX package"

      - name: Create stable release tag
        if: steps.tag-check.outputs.exists == 'false'
        run: |
          VERSION=${{ steps.final-version.outputs.version }}
          git config user.name "Release Bot"
          git config user.email "release@bot.local"
          
          git tag -a "v${VERSION}" -m "Release v${VERSION}"
          git push origin "v${VERSION}"
          
          # Update latest-stable tracking tag
          git tag -f latest-stable
          git push -f origin latest-stable
          
          echo "âœ… Tagged v${VERSION} as stable release"

      - name: Create GitHub stable release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.final-version.outputs.version }}
          VSIX_FILE="vsix/ai-skeleton-extension-${VERSION}.vsix"
          
          # Create or update stable release
          gh release create "v${VERSION}" \
            --title "Release v${VERSION}" \
            --notes "ðŸŽ‰ Stable release v${VERSION}" \
            --latest \
            "$VSIX_FILE" || \
          gh release upload "v${VERSION}" "$VSIX_FILE" --clobber
          
          echo "âœ… Created/updated GitHub release v${VERSION}"

      - name: Publish to VS Code Marketplace
        if: ${{ env.VSCE_PAT != '' }}
        run: |
          VERSION=${{ steps.final-version.outputs.version }}
          npx @vscode/vsce publish --packagePath "vsix/ai-skeleton-extension-${VERSION}.vsix" --pat "$VSCE_PAT"
          echo "âœ… Published to VS Code Marketplace"
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: Publish to VS Code Marketplace
        if: ${{ env.VSCE_PAT != '' }}
        run: |
          VERSION=${{ steps.final-version.outputs.version }}
          npx @vscode/vsce publish --packagePath "vsix/ai-skeleton-extension-${VERSION}.vsix" --pat "$VSCE_PAT"
          echo "âœ… Published to VS Code Marketplace"
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Release Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ steps.final-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** latest-stable" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Published To" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… GitHub Release" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… VS Code Marketplace" >> $GITHUB_STEP_SUMMARY

