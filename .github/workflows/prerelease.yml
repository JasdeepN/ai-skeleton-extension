name: Pre-Release

on:
  push:
    branches: [staging]
  workflow_dispatch:

permissions:
  contents: write
  id-token: write
  issues: write
  pull-requests: write

env:
  NODE_VERSION: '20.x'

jobs:
  prerelease:
    name: Create Pre-Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get current version
        id: current-version
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Pre-release version: $VERSION"

      - name: Check for existing tag
        id: tag-check
        run: |
          VERSION=${{ steps.current-version.outputs.version }}
          git fetch --tags --prune --prune-tags
          
          if git rev-parse "refs/tags/v${VERSION}-pre" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Tag v${VERSION}-pre already exists, skipping"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ… Creating new tag v${VERSION}-pre"
          fi

      - name: Compile TypeScript
        run: npm run compile

      - name: Package VSIX
        run: |
          mkdir -p vsix
          npx @vscode/vsce package --out vsix/ai-skeleton-extension-${{ steps.current-version.outputs.version }}.vsix

      - name: Create pre-release tag
        if: steps.tag-check.outputs.exists == 'false'
        run: |
          git config user.name "Pre-Release Bot"
          git config user.email "prerelease@bot.local"
          
          VERSION=${{ steps.current-version.outputs.version }}
          git tag -a "v${VERSION}-pre" -m "Pre-release v${VERSION}"
          git push origin "v${VERSION}-pre"
          
          # Update latest-prerelease tracking tag
          git tag -f latest-prerelease
          git push -f origin latest-prerelease
          
          echo "âœ… Tagged v${VERSION}-pre"

      - name: Create GitHub pre-release
        if: steps.tag-check.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.current-version.outputs.version }}
          VSIX_FILE="vsix/ai-skeleton-extension-${VERSION}.vsix"
          
          # Create pre-release on GitHub
          gh release create "v${VERSION}-pre" \
            --title "Pre-Release v${VERSION}" \
            --notes "ðŸš§ Pre-release build from staging branch" \
            --prerelease \
            "$VSIX_FILE"
          
          echo "âœ… Created GitHub pre-release v${VERSION}"
