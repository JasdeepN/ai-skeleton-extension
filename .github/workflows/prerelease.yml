name: Pre-Release

on:
  push:
    branches: [staging]
  workflow_dispatch:

permissions:
  contents: write
  id-token: write
  issues: write
  pull-requests: write

env:
  NODE_VERSION: '20.x'

jobs:
  prerelease:
    name: Create Pre-Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get current version
        id: current-version
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Current version: $VERSION"

      - name: Validate and convert to pre-release version
        id: prerelease-version
        run: |
          CURRENT_VERSION=${{ steps.current-version.outputs.version }}
          
          # Parse version components
          MAJOR=$(echo "$CURRENT_VERSION" | cut -d. -f1)
          MINOR=$(echo "$CURRENT_VERSION" | cut -d. -f2)
          PATCH=$(echo "$CURRENT_VERSION" | cut -d. -f3)
          
          # Check if minor version is even (release version)
          if [ $((MINOR % 2)) -eq 0 ]; then
            # Convert to odd minor for pre-release (e.g., 0.2.x -> 0.3.0)
            NEW_MINOR=$((MINOR + 1))
            PRERELEASE_VERSION="${MAJOR}.${NEW_MINOR}.0"
            echo "â„¹ï¸ Converting release version ${CURRENT_VERSION} to pre-release ${PRERELEASE_VERSION}"
          else
            # Already odd minor, use as-is
            PRERELEASE_VERSION="$CURRENT_VERSION"
            echo "âœ… Version ${CURRENT_VERSION} is already pre-release format (odd minor)"
          fi
          
          echo "version=$PRERELEASE_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Pre-release version: $PRERELEASE_VERSION"

      - name: Check for existing tag
        id: tag-check
        run: |
          VERSION=${{ steps.prerelease-version.outputs.version }}
          git fetch --tags --prune --prune-tags
          
          if git rev-parse "refs/tags/v${VERSION}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Tag v${VERSION} already exists, skipping"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ… Creating new tag v${VERSION}"
          fi

      - name: Compile TypeScript
        run: npm run compile

      - name: Package VSIX
        run: |
          mkdir -p vsix
          npx @vscode/vsce package --out vsix/ai-skeleton-extension-${{ steps.prerelease-version.outputs.version }}.vsix --pre-release

      - name: Create pre-release tag
        if: steps.tag-check.outputs.exists == 'false'
        run: |
          git config user.name "Pre-Release Bot"
          git config user.email "prerelease@bot.local"
          
          VERSION=${{ steps.prerelease-version.outputs.version }}
          git tag -a "v${VERSION}" -m "Pre-release v${VERSION}"
          git push origin "v${VERSION}"
          
          # Update latest-prerelease tracking tag
          git tag -f latest-prerelease
          git push -f origin latest-prerelease
          
          echo "âœ… Tagged v${VERSION}"

      - name: Create GitHub pre-release
        if: steps.tag-check.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.prerelease-version.outputs.version }}
          VSIX_FILE="vsix/ai-skeleton-extension-${VERSION}.vsix"
          
          # Create pre-release on GitHub
          gh release create "v${VERSION}" \
            --title "Pre-Release v${VERSION}" \
            --notes "ðŸš§ **Pre-release version** - Uses odd minor version (${VERSION}) per VS Code extension requirements.
            
            This pre-release is for testing and early access. Stable releases use even minor versions (e.g., 0.2.x).
            
            **Requirements:**
            - VS Code >= 1.63.0 (for pre-release support)
            
            **Note:** Pre-release users will automatically update to stable releases if they have higher version numbers." \
            --prerelease \
            "$VSIX_FILE"
          
          echo "âœ… Created GitHub pre-release v${VERSION}"
